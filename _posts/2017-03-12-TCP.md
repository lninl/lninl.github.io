---
layout: post
title: "TCP/IP 协议族"
date: 2017-03-12
---

### 自适应重发(超时重传)

##### 自适应重发的关键点：

* 重发定时器及退避
* 基于窗口的流量控制
* 最大报文长度的计算
* 避免拥塞及拥塞控制
* 往返时延的估计

##### 重发定时器及退避:

TCP 应用了累计确认策略，每个确认中都带了一个序号。该序号指出远程站目前已接收到数据流中多少个连续八位组。    
TCP采用"Kam算法"的技术来控制重发定时器的值。一旦重发开始，"Kam算法"将重发超时时间翻倍。为实现"Kam算法"，软件保存 **重发超时的时限，开始重发的标志，重发次数计数器**  。为防止超时时限变得任意长，最大超时时限为计算出的超时时限和常量 TCP_MAXRXT 值两者中较小的值。

##### 基于窗口的流量控制：

接收方的确认报文段中包括一个"窗口通告"，使发送方得知接收方还有多大的缓冲空间用以存放新增数据。TCP利用窗口通告来控制一个连接上的数据流量。接收方可以通过通告一个较小的窗口大小来限制发送方生成的数据量。极端情况下，通告一个大小为零的窗口可以完全终止数据传输。    
不仅仅因为接收方决定减小缓冲区大小才减小窗口通告，在发送方提供数据且确认序号不断增加的情况下，窗口通告才有可能减小。  

**糊涂窗口综合症**：当接收方窗口在0到一个很小的正值之间摆动不定时产生，此时发送方在窗口打开的同时，传送几个小报文段就又填满窗口。这导致很低的网络利用率，报文段包含的数据与 TCP 和 IP 首部相比很少。  
**糊涂窗口综合症的解决方法(Nagle算法)**：一旦接收方通告了一个零窗口，就必须延迟对下一个非零窗口的通告，知道具有"较大"的缓冲区空间时。较大是指存放最大报文段的空间，或四分之一的缓冲区空间两者中较大的一个值。

##### 最大报文长度的计算(MSS)
TCP 在三次握手操作的互相交换请求阶段，同时为传入和外发报文段协商其 MSS。一旦 TCP 为这两个方向各自确认一个 MSS 之后，就不再改变他们的值。

##### 拥塞控制：
发送端判断拥塞发生的依据：

* 传输超时---慢启动和拥塞避免 
* 收到重复的确认报文段---快速重传和快速恢复

发送端连续收到3个重复的确认报文段，就认为拥塞发生了。

为避免拥塞恶化，在分组延迟或丢失发生时减少分组的重发量。  
**成倍递减法**：发送方的 TCP 维护管理一个拥塞窗口的内部变量，该变量用于限制发送的数据量。在传输时，TCP选用接收方通告的窗口值和内部拥塞窗口值中较小的一个来决定发送的数据量。每次重发事件的发生，将拥塞窗口减小一半，不能小于一个报文段要求的大小。取决于min(通告值/2，拥塞窗口/2)

##### 慢启动与拥塞预防：

TCP 在开始在一条新建立的连接上发送数据时，和从拥塞中恢复时采用慢启动的技术。慢启动恰好与成倍递减相反，它提供了成倍递增技术。  
**慢启动**：拥塞窗口的初始值是一个最大报文段的长度，并发送一个报文段。在重发定时器超时之前接收到相应的确认报文，该拥塞窗口尺寸就增长为两个报文段长度。每当有一个确认按时到达，则拥塞窗口尺寸就增加一个报文段，知道达到由成倍递减设置的上限值。  超过上限后减速递增。  
**拥塞预防**：一旦拥塞窗口大小到达上限值之后，TCP 减慢器增长速度。TCP在没经过一个往返时延后，才将拥塞窗口尺寸增大一个报文长度，而不是每接收到一个确认就增大一个包文长度。没接收一个确认，拥塞窗口就增大一点。增量= (MMS * MMS) / 拥塞窗口大小 

##### 往返时延的估计：

TCP的性能取决于能否有效的估算一个连接数据的平均往返时延。TCP 利用过去的样本值来估计现在的往返时延，并由该往返时延计算并选择重发超时时间。同时估算往返时延的平均值和方差，掌握往返时延的方差，使TCP能够计算出可适应波动的超时时间，而无需做不必要的重发。  

滚动平均值(average) & 滚动平均偏差(deviation)：

		error = measurement - average
		average = average + @ * error
		deviation = deviation + @ * (|error| - deviation)
		@ = 1/2^n		n常规值为3
		新测量值：measurement

### TCP/IP 实现
输入进程结构：
![输入进程结构](http://i.imgur.com/coXWmI2.png)

输出进程结构：
![输出进程结构](http://i.imgur.com/JgzLUjR.png)

TCP/IP 协议软件是计算机操作系统中的一部分。使用进程这一抽象概念使各个协议软件相互独立。每个进程独立执行，并提供明确的并行机制。这个系统中有 IP 进程、TCP输入进程、TCP输出进程、TCP定时器管理进程。　　
操作系统提供信号量机制，实现进程间的通讯。同时提供端口机制，允许进程通过一个优先队列互相发送消息。端口机制利用信号量来协调使用队列的多个进程。

##### 传输控制块 TCB

TCP 通过一个数据结构(TCB)为每个 TCP 连接协调传送、接收和重发动作，这个数据结构被所有进程共享。  
传输控制块 TCB(transmission control block)：TCP为每个活动的连接保留一个 TCB 。TCB 中包含了有关 TCP 连接的所有信息，包括：
  
* 输入、输出状态，一个互斥信号量、本地和远程IP地址和端口号，...
* 发送报文段需要的信息：接收方当前窗口大小，准备发送的下一个报文段的序号，序列中还未确认的报文的最低字节，拥塞窗口大小，慢启动阈值以及最大报文段长度。
* 重发信息：已平滑过得平均往返延时估值，往返时延偏差估值，重发超时时间，以及连续重发次数的计数器。
* 接收报文的字段：接收缓冲区的地址，有效数据的起点的字段，计算接收缓冲区中字符数的计数器，最大允许报文段长度和上一次通告窗口的序号。
* 保存与报文顺序有关的数据块信息，保存在链表中，直至这些数据块能被重组成连续的数据流。

##### TCP 有限状态机  
理论上讲，TCP使用有限状态机制控制所有进程的交互作用。但在事实上， **有限状态机规定了 TCP 在响应一个输入或用户命令时，如何在各个宏观状态之间互相变迁。一个具体的实现还要包括另一个独立的机制，用来完成各个微观状态之间的相互变迁，以控制输出和重发动作。** 

TCP状态转换图：
![状态转换图](http://i.imgur.com/Sl2uPXs.jpg)

TCP连接的分组交换：
![TCP连接的分组交换](http://i.imgur.com/KnzLPdC.png)

TCB 的创建与消亡： 
 
* 创建：服务器在接收到 SYN 报文段后，以一个 SYN+ACK 报文作为应答，并创建一个新的TCB。  
* 初始化：应用程序发起"主动打开"或"被动打开"操作时初始化 TCB。  
* 删除：
	* TIME_WAIT 状态：收到任何报文，意味着确认被丢失，TCP 以正常方式响应该报文。并取消旧的删除事件，并安排新的删除事件。这将导致如果连接一方不断的发送报文，对方机器上的资源被无限期的占有。
	* CLOSING 状态：删除定时器事件，启动删除 TCB 的定时器。  
	* `FIN_WAIT_2` 状态：删除定时器事件，创立一个 TCB 删除事件。

**TIME_WAIT 状态：** 

* 可靠的终止 TCP 连接。最终的ACK可能丢失，服务器重发 FIN，因此客户必须维护状态信息，使 TCP 能够正确的处理延迟报文。
* 防止老的重复分节干扰下一个连接。新连接成为前一个连接的化身，而接受上一个连接的报文。TIME_WAIT 持续 2*MSL ，保证前一个连接的重复分组都已经在网络中消失。

服务器使用被动打开为某个 TCP 端口创建一个连接队列。TCP 为每个新连接分配一个新 TCB，将连接表示符放在对应于该端口的监听队列中，并唤醒服务进程，处理新连接。

# 连接队列 ？

### TCP 时延 (http 权威指南91）
* TCP 连接建立握手
* TCP 慢启动拥塞控制
* 数据聚焦的 Nagle 算法
	* 在发送一个分组之前，将大量TCP数据绑定在一起，以提高网络效率。设置参数 TCP_NODELAY，禁用 Nagle 算法
* 用于捎带确认的 TCP 延迟确认算法
* TIME_WAIT 时延和端口耗尽

处理一个输入报文段的流程：

* 将 TCP 首部装换为本地字节顺序
* 计算 TCP 的校验和
* 为报文段查找对应 TCB
* 检查报文段的有效性
* 为当前状态选择一个处理过程

### TCP vs UDP (可靠 vs 效率) 
长处也是短处

TCP 协议的特点：面向连接、字节流、可靠
  
* TCP 协议通讯的双方必须建立连接，才能传输数据。双方需要为连接非配必要的内核资源，以管理连接的状态和连接上数据的传输。这种连接方式是一对一的，不能提供广播和多播服务。
* 字节流服务：应用程序对数据的发送和接收没有边界限制。在缓冲区中，读和写的次数之间没有关系。UDP 发送一次必须读一次，否则未读取的数据丢失。
* 可靠：TCP 采用应答机制、超时重传机制、并对报文重排、整理。
* 连接、重传、拥塞控制也限制了 TCP 传输的速度


UDP 协议的特点：无连接、不可靠、数据报

* 传出速度快，实时性高

### 参考文献

HTTP 权威指南  
[TCP](http://coolshell.cn/articles/11564.html)  
[TCP](http://coolshell.cn/articles/11609.html)
